<!DOCTYPE html>
<html>
<head>
    <title>–ö–ª–∏–µ–Ω—Ç—ã - –ú–æ–π –ë–∏–∑–Ω–µ—Å</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        .stats-number { 
            font-size: 1.2rem; 
            font-weight: bold; 
        }
        .customer-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
            margin-top: 10px;
        }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        @media (max-width: 768px) {
            .mobile-card {
                border: 1px solid #ddd;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 15px;
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .nav-buttons {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
                margin-bottom: 15px;
            }
            .nav-buttons .btn {
                font-size: 0.8rem;
                padding: 6px 8px;
            }
            .desktop-view { display: none; }
        }
        
        /* –î–µ—Å–∫—Ç–æ–ø–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        @media (min-width: 769px) {
            .container { max-width: 1200px; }
            .nav-buttons {
                display: flex;
                gap: 10px;
                margin-bottom: 25px;
                justify-content: center;
            }
            .nav-buttons .btn {
                font-size: 1rem;
                padding: 10px 20px;
                min-width: 120px;
            }
            .desktop-card {
                background: white;
                border-radius: 10px;
                padding: 25px;
                margin-bottom: 25px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                border: 1px solid #e9ecef;
            }
            .customer-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                gap: 20px;
            }
            .customer-card {
                background: white;
                border-radius: 10px;
                padding: 20px;
                border: 1px solid #e9ecef;
                transition: transform 0.2s, box-shadow 0.2s;
            }
            .customer-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            }
            .stats-number { 
                font-size: 1.5rem; 
            }
            .mobile-view { display: none; }
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <h4 class="text-center mb-3">üë• –ö–ª–∏–µ–Ω—Ç—ã</h4>
        
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="nav-buttons">
            <a href="/dashboard" class="btn btn-outline-secondary">üìà –î–∞—à–±–æ—Ä–¥</a>
            <a href="/orders" class="btn btn-outline-primary">üì¶ –ó–∞–∫–∞–∑—ã</a>
            <a href="/warehouse" class="btn btn-outline-warning">üè™ –°–∫–ª–∞–¥</a>
            <a href="/sales" class="btn btn-outline-success">üí∞ –ü—Ä–æ–¥–∞–∂–∏</a>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
        <div class="desktop-view">
            <div class="desktop-card mb-3">
                <div class="row g-3 align-items-center">
                    <!-- –ü–æ–∏—Å–∫ -->
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text">üîç</span>
                            <input type="text" 
                                   class="form-control" 
                                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É, –≥–æ—Ä–æ–¥—É..." 
                                   id="searchInput"
                                   value="{{ search_query }}">
                            <button class="btn btn-outline-secondary" type="button" onclick="performSearch()">
                                –ù–∞–π—Ç–∏
                            </button>
                        </div>
                    </div>
                    
                    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –≥–æ—Ä–æ–¥—É -->
                    <div class="col-md-3">
                        <select class="form-select" id="cityFilter" onchange="performSearch()">
                            <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
                            {% for city in cities %}
                            <option value="{{ city }}" {% if city_filter == city %}selected{% endif %}>{{ city }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
                    <div class="col-md-3">
                        <select class="form-select" id="sortSelect" onchange="performSearch()">
                            <option value="name" {% if sort_by == 'name' %}selected{% endif %}>–ü–æ –∏–º–µ–Ω–∏</option>
                            <option value="orders" {% if sort_by == 'orders' %}selected{% endif %}>–ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–∫–∞–∑–æ–≤</option>
                            <option value="sales" {% if sort_by == 'sales' %}selected{% endif %}>–ü–æ –≤—ã—Ä—É—á–∫–µ</option>
                            <option value="profit" {% if sort_by == 'profit' %}selected{% endif %}>–ü–æ –ø—Ä–∏–±—ã–ª–∏</option>
                            <option value="city" {% if sort_by == 'city' %}selected{% endif %}>–ü–æ –≥–æ—Ä–æ–¥—É</option>
                        </select>
                    </div>
                    
                    <!-- –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ -->
                    <div class="col-md-2">
                        <select class="form-select" id="orderSelect" onchange="performSearch()">
                            <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                            <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                        </select>
                    </div>
                </div>
                
                <!-- –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                –ù–∞–π–¥–µ–Ω–æ: {{ customers|length }} –∫–ª–∏–µ–Ω—Ç–æ–≤
                                {% if search_query or city_filter %}
                                <span class="badge bg-info ms-2">–§–∏–ª—å—Ç—Ä—ã –∞–∫—Ç–∏–≤–Ω—ã</span>
                                {% endif %}
                            </small>
                            {% if search_query or city_filter %}
                            <a href="/customers" class="btn btn-outline-secondary btn-sm">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø–æ–∏—Å–∫–∞ -->
        <div class="mobile-view">
            <div class="card mb-3">
                <div class="card-body">
                    <!-- –ü–æ–∏—Å–∫ -->
                    <div class="mb-2">
                        <div class="input-group input-group-sm">
                            <input type="text" 
                                   class="form-control" 
                                   placeholder="–ü–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤..." 
                                   id="searchInputMobile"
                                   value="{{ search_query }}">
                            <button class="btn btn-outline-primary" type="button" onclick="performSearchMobile()">
                                üîç
                            </button>
                        </div>
                    </div>
                    
                    <div class="row g-2">
                        <!-- –§–∏–ª—å—Ç—Ä –ø–æ –≥–æ—Ä–æ–¥—É -->
                        <div class="col-6">
                            <select class="form-select form-select-sm" id="cityFilterMobile" onchange="performSearchMobile()">
                                <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
                                {% for city in cities %}
                                <option value="{{ city }}" {% if city_filter == city %}selected{% endif %}>{{ city }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
                        <div class="col-6">
                            <select class="form-select form-select-sm" id="sortSelectMobile" onchange="performSearchMobile()">
                                <option value="name" {% if sort_by == 'name' %}selected{% endif %}>–ü–æ –∏–º–µ–Ω–∏</option>
                                <option value="sales" {% if sort_by == 'sales' %}selected{% endif %}>–ü–æ –≤—ã—Ä—É—á–∫–µ</option>
                                <option value="orders" {% if sort_by == 'orders' %}selected{% endif %}>–ü–æ –∑–∞–∫–∞–∑–∞–º</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
                    {% if search_query or city_filter %}
                    <div class="mt-2 text-center">
                        <a href="/customers" class="btn btn-outline-secondary btn-sm w-100">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –î–ï–°–ö–¢–û–ü–ù–ê–Ø –í–ï–†–°–ò–Ø -->
        <div class="desktop-view">
            <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ -->
            <div class="desktop-card">
                <h5 class="mb-4">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞</h5>
                <form method="POST" action="/add_customer" class="row g-3">
                    <div class="col-md-4">
                        <input type="text" name="name" class="form-control" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞" required>
                    </div>
                    <div class="col-md-3">
                        <input type="text" name="phone" class="form-control" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
                    </div>
                    <div class="col-md-3">
                        <input type="text" name="city" class="form-control" placeholder="–ì–æ—Ä–æ–¥">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </form>
            </div>

            <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            {% if customers %}
            <div class="desktop-card">
                <h5 class="mb-4 text-center">üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º</h5>
                <div class="row text-center">
                    <div class="col-3">
                        <div class="stats-number text-primary" style="font-size: 2rem;">{{ customers|length }}</div>
                        <div class="text-muted">–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                    </div>
                    <div class="col-3">
                        <div class="stats-number text-success" style="font-size: 2rem;">{{ "%.0f"|format(customers|sum(attribute='total_sales')) }}</div>
                        <div class="text-muted">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ (TJS)</div>
                    </div>
                    <div class="col-3">
                        <div class="stats-number text-info" style="font-size: 2rem;">{{ "%.0f"|format(customers|sum(attribute='total_profit')) }}</div>
                        <div class="text-muted">–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å (TJS)</div>
                    </div>
                    <div class="col-3">
                        <div class="stats-number text-warning" style="font-size: 2rem;">{{ customers|sum(attribute='total_orders') }}</div>
                        <div class="text-muted">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
            <div class="desktop-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">üë§ –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
                    <span class="badge bg-primary fs-6">{{ customers|length }} –∫–ª–∏–µ–Ω—Ç–æ–≤</span>
                </div>
                
                {% if customers %}
                <div class="customer-grid">
                    {% for customer in customers %}
                    <div class="customer-card">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="mb-0">{{ customer.name }}</h5>
                            <span class="badge bg-light text-dark">
                                —Å {{ customer.created_at.strftime('%d.%m.%Y') }}
                            </span>
                        </div>
                        
                        <div class="mb-3">
                            {% if customer.phone %}
                            <div class="d-flex align-items-center mb-2">
                                <span class="text-muted me-2">üìû</span>
                                <span>{{ customer.phone }}</span>
                            </div>
                            {% endif %}
                            
                            {% if customer.city %}
                            <div class="d-flex align-items-center">
                                <span class="text-muted me-2">üèôÔ∏è</span>
                                <span>{{ customer.city }}</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="row text-center mb-3">
                            <div class="col-4">
                                <div class="stats-number text-primary">{{ customer.total_orders }}</div>
                                <small class="text-muted">–ó–∞–∫–∞–∑–æ–≤</small>
                            </div>
                            <div class="col-4">
                                <div class="stats-number text-success">{{ "%.0f"|format(customer.total_sales) }}</div>
                                <small class="text-muted">–í—ã—Ä—É—á–∫–∞</small>
                            </div>
                            <div class="col-4">
                                <div class="stats-number text-info">{{ "%.0f"|format(customer.total_profit) }}</div>
                                <small class="text-muted">–ü—Ä–∏–±—ã–ª—å</small>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <a href="/customer/{{ customer.id }}" class="btn btn-outline-primary btn-sm">üìä –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
                            <a href="/delete_customer/{{ customer.id }}" 
                               class="btn btn-outline-danger btn-sm"
                               onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ {{ customer.name }}?')">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="text-muted mb-3" style="font-size: 4rem;">üë•</div>
                    <h4 class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</h4>
                    <p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –≤—ã—à–µ</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø -->
        <div class="mobile-view">
            <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ -->
            <div class="card mb-3">
                <div class="card-body py-2">
                    <h6 class="card-title">‚ûï –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</h6>
                    <form method="POST" action="/add_customer">
                        <div class="row g-1">
                            <div class="col-12">
                                <input type="text" name="name" class="form-control form-control-sm" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞" required>
                            </div>
                            <div class="col-6">
                                <input type="text" name="phone" class="form-control form-control-sm" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
                            </div>
                            <div class="col-6">
                                <input type="text" name="city" class="form-control form-control-sm" placeholder="–ì–æ—Ä–æ–¥">
                            </div>
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-sm w-100 mt-1">–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
            {% for customer in customers %}
            <div class="mobile-card">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <strong>{{ customer.name }}</strong>
                        {% if customer.phone %}
                        <div class="text-muted small">üìû {{ customer.phone }}</div>
                        {% endif %}
                        {% if customer.city %}
                        <div class="text-muted small">üèôÔ∏è {{ customer.city }}</div>
                        {% endif %}
                    </div>
                    <span class="badge bg-light text-dark small">
                        {{ customer.created_at.strftime('%d.%m.%y') }}
                    </span>
                </div>
                
                <div class="customer-stats">
                    <div>
                        <div class="stats-number text-primary">{{ customer.total_orders }}</div>
                        <small>–ó–∞–∫–∞–∑—ã</small>
                    </div>
                    <div>
                        <div class="stats-number text-success">{{ "%.0f"|format(customer.total_sales) }}</div>
                        <small>–í—ã—Ä—É—á–∫–∞</small>
                    </div>
                    <div>
                        <div class="stats-number text-info">{{ "%.0f"|format(customer.total_profit) }}</div>
                        <small>–ü—Ä–∏–±—ã–ª—å</small>
                    </div>
                </div>
                
                <div class="text-center mt-2">
                    <a href="/customer/{{ customer.id }}" class="btn btn-outline-primary btn-sm">üìä –î–µ—Ç–∞–ª–∏</a>
                    <a href="/delete_customer/{{ customer.id }}" 
                       class="btn btn-outline-danger btn-sm"
                       onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ {{ customer.name }}?')">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                    </a>
                </div>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <h5>üë• –ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
                <p>–î–æ–±–∞–≤—å –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –≤—ã—à–µ</p>
            </div>
            {% endfor %}

            <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            {% if customers %}
            <div class="card mt-3">
                <div class="card-body py-2">
                    <h6 class="text-center">üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h6>
                    <div class="row text-center small">
                        <div class="col-3">
                            <div class="text-primary">{{ customers|length }}</div>
                            <small>–ö–ª–∏–µ–Ω—Ç–æ–≤</small>
                        </div>
                        <div class="col-3">
                            <div class="text-success">{{ "%.0f"|format(customers|sum(attribute='total_sales')) }}</div>
                            <small>–í—ã—Ä—É—á–∫–∞</small>
                        </div>
                        <div class="col-3">
                            <div class="text-info">{{ "%.0f"|format(customers|sum(attribute='total_profit')) }}</div>
                            <small>–ü—Ä–∏–±—ã–ª—å</small>
                        </div>
                        <div class="col-3">
                            <div class="text-warning">{{ customers|sum(attribute='total_orders') }}</div>
                            <small>–ó–∞–∫–∞–∑—ã</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –≤–µ—Ä—Å–∏–∏
        function performSearch() {
            const search = document.getElementById('searchInput').value;
            const city = document.getElementById('cityFilter').value;
            const sort = document.getElementById('sortSelect').value;
            const order = document.getElementById('orderSelect').value;
            
            let url = `/customers?search=${encodeURIComponent(search)}&city=${encodeURIComponent(city)}&sort=${sort}&order=${order}`;
            window.location.href = url;
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
        function performSearchMobile() {
            const search = document.getElementById('searchInputMobile').value;
            const city = document.getElementById('cityFilterMobile').value;
            const sort = document.getElementById('sortSelectMobile').value;
            
            let url = `/customers?search=${encodeURIComponent(search)}&city=${encodeURIComponent(city)}&sort=${sort}&order=desc`;
            window.location.href = url;
        }
        
        // –ü–æ–∏—Å–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter
        document.getElementById('searchInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performSearch();
        });
        
        document.getElementById('searchInputMobile')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performSearchMobile();
        });
    </script>
</body>
</html>