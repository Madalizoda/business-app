<!DOCTYPE html>
<html>
<head>
    <title>–ü—Ä–æ–¥–∞–∂–∏ - –ú–æ–π –ë–∏–∑–Ω–µ—Å</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        .profit-positive { color: #28a745; font-weight: bold; }
        .profit-negative { color: #dc3545; font-weight: bold; }
        
        /* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        @media (max-width: 768px) {
            .mobile-card {
                border: 1px solid #ddd;
                border-radius: 10px;
                padding: 15px;
                margin-bottom: 15px;
                background: white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .nav-buttons {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 5px;
                margin-bottom: 15px;
            }
            .nav-buttons .btn {
                font-size: 0.8rem;
                padding: 6px 8px;
            }
            .summary-card { 
                background: #f8f9fa; 
                border-radius: 10px; 
                padding: 15px; 
                margin-bottom: 15px;
                text-align: center;
            }
            .desktop-view { display: none; }
        }
        
        /* –î–µ—Å–∫—Ç–æ–ø–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        @media (min-width: 769px) {
            .container { max-width: 1200px; }
            .nav-buttons {
                display: flex;
                gap: 10px;
                margin-bottom: 25px;
                justify-content: center;
            }
            .nav-buttons .btn {
                font-size: 1rem;
                padding: 10px 20px;
                min-width: 120px;
            }
            .desktop-card {
                background: white;
                border-radius: 10px;
                padding: 25px;
                margin-bottom: 25px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                border: 1px solid #e9ecef;
            }
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 20px;
                margin-bottom: 25px;
            }
            .stat-card {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 10px;
                padding: 25px;
                text-align: center;
                transition: transform 0.2s;
            }
            .stat-card:hover {
                transform: translateY(-2px);
            }
            .stat-number { 
                font-size: 2rem; 
                font-weight: bold; 
            }
            .mobile-view { display: none; }
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <h4 class="text-center mb-3">üí∞ –ü—Ä–æ–¥–∞–∂–∏</h4>
        
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="nav-buttons">
            <a href="/dashboard" class="btn btn-outline-secondary">üìà –î–∞—à–±–æ—Ä–¥</a>
            <a href="/orders" class="btn btn-outline-primary">üì¶ –ó–∞–∫–∞–∑—ã</a>
            <a href="/warehouse" class="btn btn-outline-warning">üè™ –°–∫–ª–∞–¥</a>
            <a href="/customers" class="btn btn-outline-info">üë• –ö–ª–∏–µ–Ω—Ç—ã</a>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
        <div class="desktop-view">
            <div class="desktop-card mb-3">
                <div class="row g-3 align-items-center">
                    <!-- –ü–æ–∏—Å–∫ -->
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text">üîç</span>
                            <input type="text" 
                                   class="form-control" 
                                   placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä—É, ‚Ññ –∑–∞–∫–∞–∑–∞, –∫–ª–∏–µ–Ω—Ç—É..." 
                                   id="searchInput"
                                   value="{{ search_query }}">
                            <button class="btn btn-outline-secondary" type="button" onclick="performSearch()">
                                –ù–∞–π—Ç–∏
                            </button>
                        </div>
                    </div>
                    
                    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ -->
                    <div class="col-md-3">
                        <input type="date" 
                               class="form-control" 
                               id="dateFilter"
                               value="{{ date_filter }}"
                               onchange="performSearch()">
                    </div>
                    
                    <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
                    <div class="col-md-3">
                        <select class="form-select" id="sortSelect" onchange="performSearch()">
                            <option value="sale_date" {% if sort_by == 'sale_date' %}selected{% endif %}>–ü–æ –¥–∞—Ç–µ –ø—Ä–æ–¥–∞–∂–∏</option>
                            <option value="product" {% if sort_by == 'product' %}selected{% endif %}>–ü–æ —Ç–æ–≤–∞—Ä—É</option>
                            <option value="customer" {% if sort_by == 'customer' %}selected{% endif %}>–ü–æ –∫–ª–∏–µ–Ω—Ç—É</option>
                            <option value="price" {% if sort_by == 'price' %}selected{% endif %}>–ü–æ —Ü–µ–Ω–µ –ø—Ä–æ–¥–∞–∂–∏</option>
                            <option value="profit" {% if sort_by == 'profit' %}selected{% endif %}>–ü–æ –ø—Ä–∏–±—ã–ª–∏</option>
                        </select>
                    </div>
                    
                    <!-- –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ -->
                    <div class="col-md-2">
                        <select class="form-select" id="orderSelect" onchange="performSearch()">
                            <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                            <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                        </select>
                    </div>
                </div>
                
                <!-- –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                –ù–∞–π–¥–µ–Ω–æ: {{ sales|length }} –ø—Ä–æ–¥–∞–∂
                                {% if search_query or date_filter %}
                                <span class="badge bg-info ms-2">–§–∏–ª—å—Ç—Ä—ã –∞–∫—Ç–∏–≤–Ω—ã</span>
                                {% endif %}
                            </small>
                            {% if search_query or date_filter %}
                            <a href="/sales" class="btn btn-outline-secondary btn-sm">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø–æ–∏—Å–∫–∞ -->
        <div class="mobile-view">
            <div class="card mb-3">
                <div class="card-body">
                    <!-- –ü–æ–∏—Å–∫ -->
                    <div class="mb-2">
                        <div class="input-group input-group-sm">
                            <input type="text" 
                                   class="form-control" 
                                   placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–¥–∞–∂..." 
                                   id="searchInputMobile"
                                   value="{{ search_query }}">
                            <button class="btn btn-outline-primary" type="button" onclick="performSearchMobile()">
                                üîç
                            </button>
                        </div>
                    </div>
                    
                    <div class="row g-2">
                        <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ -->
                        <div class="col-6">
                            <input type="date" 
                                   class="form-control form-control-sm" 
                                   id="dateFilterMobile"
                                   value="{{ date_filter }}"
                                   onchange="performSearchMobile()">
                        </div>
                        
                        <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
                        <div class="col-6">
                            <select class="form-select form-select-sm" id="sortSelectMobile" onchange="performSearchMobile()">
                                <option value="sale_date" {% if sort_by == 'sale_date' %}selected{% endif %}>–ü–æ –¥–∞—Ç–µ</option>
                                <option value="product" {% if sort_by == 'product' %}selected{% endif %}>–ü–æ —Ç–æ–≤–∞—Ä—É</option>
                                <option value="price" {% if sort_by == 'price' %}selected{% endif %}>–ü–æ —Ü–µ–Ω–µ</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
                    {% if search_query or date_filter %}
                    <div class="mt-2 text-center">
                        <a href="/sales" class="btn btn-outline-secondary btn-sm w-100">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –î–ï–°–ö–¢–û–ü–ù–ê–Ø –í–ï–†–°–ò–Ø -->
        <div class="desktop-view">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ -->
            <div class="stats-grid">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="stat-number">{{ sales|length }}</div>
                    <small>–í—Å–µ–≥–æ –ø—Ä–æ–¥–∞–∂</small>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="stat-number">{{ "%.0f"|format(total_revenue) }}</div>
                    <small>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ (TJS)</small>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="stat-number">{{ "%.0f"|format(total_profit) }}</div>
                    <small>–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å (TJS)</small>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="stat-number">
                        {% if sales|length > 0 %}
                        {{ "%.0f"|format(total_revenue / sales|length) }}
                        {% else %}
                        0
                        {% endif %}
                    </div>
                    <small>–°—Ä–µ–¥–Ω–∏–π —á–µ–∫ (TJS)</small>
                </div>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥–∞–∂ -->
            <div class="desktop-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0">üìã –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–∞–∂</h4>
                    <span class="badge bg-primary fs-6">{{ sales|length }} –ø—Ä–æ–¥–∞–∂</span>
                </div>
                
                {% if sales %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>–î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏</th>
                                <th>–¢–æ–≤–∞—Ä</th>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>–ö–æ–ª-–≤–æ</th>
                                <th>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
                                <th>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏</th>
                                <th>–ü—Ä–∏–±—ã–ª—å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in sales %}
                            <tr>
                                <td><strong>{{ sale.sale_date.strftime('%d.%m.%Y %H:%M') }}</strong></td>
                                <td>
                                    <strong>{{ sale.product.name }}</strong>
                                    <br><small class="text-muted">–ó–∞–∫–∞–∑: {{ sale.product.order_number }}</small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">üë§</span>
                                        <span>{{ sale.customer.name }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ sale.quantity }} —à—Ç.</span>
                                </td>
                                <td>{{ "%.2f"|format(calculate_cost_price(sale.product)) }} TJS</td>
                                <td><strong class="text-success">{{ "%.2f"|format(sale.sale_price) }} TJS</strong></td>
                                <td class="fw-bold {% if sale.profit > 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                    {{ "%.2f"|format(sale.profit) }} TJS
                                </td>
                                <td>
                                    <a href="/return_sale/{{ sale.id }}" 
                                       class="btn btn-warning btn-sm"
                                       onclick="return confirm('–í–µ—Ä–Ω—É—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –Ω–∞ —Å–∫–ª–∞–¥?')">
                                        üîÑ –í–µ—Ä–Ω—É—Ç—å
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <td colspan="5"><strong>–ò—Ç–æ–≥–æ:</strong></td>
                                <td><strong>{{ "%.2f"|format(total_revenue) }} TJS</strong></td>
                                <td class="fw-bold text-success">{{ "%.2f"|format(total_profit) }} TJS</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="text-muted mb-3" style="font-size: 4rem;">üí∞</div>
                    <h4 class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–¥–∞–∂</h4>
                    <p class="text-muted mb-4">–í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –æ—Ç–º–µ—Ç—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∫–∞–∫ "–ü–æ–ª—É—á–µ–Ω", —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–∂–∏</p>
                    <a href="/warehouse" class="btn btn-success">–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∫–ª–∞–¥</a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø -->
        <div class="mobile-view">
            <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="row">
                <div class="col-6">
                    <div class="summary-card">
                        <div class="text-primary" style="font-size: 1.2rem;">{{ "%.0f"|format(total_revenue) }}</div>
                        <small>–í—ã—Ä—É—á–∫–∞</small>
                    </div>
                </div>
                <div class="col-6">
                    <div class="summary-card">
                        <div class="text-success" style="font-size: 1.2rem;">{{ "%.0f"|format(total_profit) }}</div>
                        <small>–ü—Ä–∏–±—ã–ª—å</small>
                    </div>
                </div>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–æ–¥–∞–∂ -->
            <div class="mobile-cards">
                {% for sale in sales %}
                <div class="mobile-card">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <strong>{{ sale.product.name }}</strong>
                            <div class="text-muted small">–ó–∞–∫–∞–∑: {{ sale.product.order_number }}</div>
                        </div>
                        <span class="badge bg-light text-dark small">
                            {{ sale.sale_date.strftime('%d.%m') }}
                        </span>
                    </div>
                    
                    <div class="mb-2">
                        <div class="small">üë§ {{ sale.customer.name }}</div>
                        <div class="small">üì¶ {{ sale.quantity }} —à—Ç.</div>
                    </div>

                    <div class="row small mb-2">
                        <div class="col-6">
                            üíµ {{ "%.2f"|format(sale.sale_price) }} TJS
                        </div>
                        <div class="col-6">
                            üìä {{ "%.2f"|format(calculate_cost_price(sale.product)) }} TJS
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <span class="{% if sale.profit > 0 %}profit-positive{% else %}profit-negative{% endif %}">
                            üéØ –ü—Ä–∏–±—ã–ª—å: {{ "%.2f"|format(sale.profit) }} TJS
                        </span>
                        <a href="/return_sale/{{ sale.id }}" 
                           class="btn btn-warning btn-sm"
                           onclick="return confirm('–í–µ—Ä–Ω—É—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –Ω–∞ —Å–∫–ª–∞–¥?')">
                            üîÑ –í–µ—Ä–Ω—É—Ç—å
                        </a>
                    </div>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <h5>üí∞ –ù–µ—Ç –ø—Ä–æ–¥–∞–∂</h5>
                    <p>–ü—Ä–æ–¥–∞–≤–∞–π —Ç–æ–≤–∞—Ä—ã —Å–æ —Å–∫–ª–∞–¥–∞ —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</p>
                    <a href="/warehouse" class="btn btn-success btn-sm">–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∫–ª–∞–¥</a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–π –≤–µ—Ä—Å–∏–∏
        function performSearch() {
            const search = document.getElementById('searchInput').value;
            const date = document.getElementById('dateFilter').value;
            const sort = document.getElementById('sortSelect').value;
            const order = document.getElementById('orderSelect').value;
            
            let url = `/sales?search=${encodeURIComponent(search)}&date=${date}&sort=${sort}&order=${order}`;
            window.location.href = url;
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
        function performSearchMobile() {
            const search = document.getElementById('searchInputMobile').value;
            const date = document.getElementById('dateFilterMobile').value;
            const sort = document.getElementById('sortSelectMobile').value;
            
            let url = `/sales?search=${encodeURIComponent(search)}&date=${date}&sort=${sort}&order=desc`;
            window.location.href = url;
        }
        
        // –ü–æ–∏—Å–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter
        document.getElementById('searchInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performSearch();
        });
        
        document.getElementById('searchInputMobile')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performSearchMobile();
        });
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –∫–∞–∫ placeholder –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –¥–∞—Ç—ã
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateFilter')?.setAttribute('placeholder', today);
            document.getElementById('dateFilterMobile')?.setAttribute('placeholder', today);
        });
    </script>
</body>
</html>