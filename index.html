<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—á—ë—Ç —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –ö–∏—Ç–∞—è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; padding: 1rem; z-index: 50; overflow-y: auto; }
        .modal-content { background: white; border-radius: 0.5rem; padding: 1.5rem; width: 100%; max-height: 90vh; overflow-y: auto; }
        @media (min-width: 640px) { .modal-content { max-width: 48rem; } }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .preview-image { max-width: 150px; max-height: 150px; object-fit: cover; border-radius: 0.5rem; }
        .thumbnail { width: 80px; height: 80px; object-fit: cover; border-radius: 0.375rem; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
            <h1 class="text-2xl font-bold mb-6 text-center">üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="password-input" class="w-full border rounded-lg px-4 py-2" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">–í–æ–π—Ç–∏</button>
                <p class="text-xs text-gray-500 text-center mt-4">–ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥? –ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å - –æ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
            </form>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="bg-white shadow-sm border-b sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
                <h1 class="text-xl sm:text-2xl font-bold">üì¶ –£—á—ë—Ç —Ç–æ–≤–∞—Ä–æ–≤</h1>
                <button onclick="logout()" class="text-red-600 hover:text-red-800 text-sm">üö™ –í—ã–π—Ç–∏</button>
            </div>
        </div>

        <div class="max-w-7xl mx-auto p-4 sm:p-6">
            <div class="flex gap-2 mb-6 border-b overflow-x-auto">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="px-4 sm:px-6 py-3 font-medium whitespace-nowrap tab-active">üìä –ü–∞–Ω–µ–ª—å</button>
                <button onclick="switchTab('orders')" id="tab-orders" class="px-4 sm:px-6 py-3 font-medium whitespace-nowrap">üì¶ –ó–∞–∫–∞–∑—ã (<span id="orders-count">0</span>)</button>
                <button onclick="switchTab('inventory')" id="tab-inventory" class="px-4 sm:px-6 py-3 font-medium whitespace-nowrap">üìã –ù–∞–ª–∏—á–∏–µ (<span id="inventory-count">0</span>)</button>
                <button onclick="switchTab('sales')" id="tab-sales" class="px-4 sm:px-6 py-3 font-medium whitespace-nowrap">üí∞ –ü—Ä–æ–¥–∞–∂–∏ (<span id="sales-count">0</span>)</button>
                <button onclick="switchTab('clients')" id="tab-clients" class="px-4 sm:px-6 py-3 font-medium whitespace-nowrap">üë• –ö–ª–∏–µ–Ω—Ç—ã</button>
                <button onclick="switchTab('personal')" id="tab-personal" class="px-4 sm:px-6 py-3 font-medium whitespace-nowrap">üè† –î–ª—è —Å–µ–±—è</button>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <input type="text" id="search" placeholder="üîç –ü–æ–∏—Å–∫..." class="flex-1 border rounded-lg px-4 py-2" oninput="renderCurrentTab()">
                <button onclick="showAddButton()" id="add-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 whitespace-nowrap">+ –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>

            <div id="content"><div class="spinner"></div></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://yyhaajwjrlkcvztskdhk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5aGFhandqcmxrY3Z6dHNrZGhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NDE2NDMsImV4cCI6MjA3OTExNzY0M30.CpnXv6Gsym1APJGB_RFKUNqJZX1zfPqkSnloanQ2JNs';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentTab = 'dashboard';
        let orders = [];
        let inventory = [];
        let sales = [];
        let personalOrders = [];
        let isLoggedIn = false;

        // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤—Ö–æ–¥–∞
        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const password = document.getElementById('password-input').value;
            
            if (password) {
                localStorage.setItem('app-password', password);
                login();
            }
        };

        function login() {
            isLoggedIn = true;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            loadData();
        }

        function logout() {
            if (confirm('–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã?')) {
                isLoggedIn = false;
                document.getElementById('app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('password-input').value = '';
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        if (localStorage.getItem('app-password')) {
            login();
        }

        async function loadData() {
            try {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã
                const { data: ordersData, error: ordersError } = await supabase
                    .from('orders')
                    .select('*');
                
                if (ordersError) {
                    console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', ordersError);
                    orders = [];
                } else {
                    orders = ordersData || [];
                    console.log('–ó–∞–∫–∞–∑—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', orders.length);
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–ª–∏—á–∏–µ
                const { data: inventoryData, error: inventoryError } = await supabase
                    .from('inventory')
                    .select('*');
                
                if (inventoryError) {
                    console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–ª–∏—á–∏—è:', inventoryError);
                    inventory = [];
                } else {
                    inventory = inventoryData || [];
                    console.log('–ù–∞–ª–∏—á–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', inventory.length);
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–¥–∞–∂–∏
                const { data: salesData, error: salesError } = await supabase
                    .from('sales')
                    .select('*');
                
                if (salesError) {
                    console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–¥–∞–∂:', salesError);
                    sales = [];
                } else {
                    sales = salesData || [];
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–∏—á–Ω—ã–µ –∑–∞–∫–∞–∑—ã
                const { data: personalData, error: personalError } = await supabase
                    .from('personal_orders')
                    .select('*');
                
                if (personalError) {
                    console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤:', personalError);
                    personalOrders = [];
                } else {
                    personalOrders = personalData || [];
                }

                updateCounts();
                renderCurrentTab();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                document.getElementById('content').innerHTML = `
                    <div class="bg-yellow-50 p-6 rounded-lg">
                        <h3 class="text-yellow-800 font-bold mb-2">‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h3>
                        <p class="text-yellow-600">–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</p>
                    </div>
                `;
            }
        }

        function updateCounts() {
            document.getElementById('orders-count').textContent = orders.length;
            document.getElementById('inventory-count').textContent = inventory.length;
            document.getElementById('sales-count').textContent = sales.length;
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.className = 'px-4 sm:px-6 py-3 font-medium whitespace-nowrap text-gray-600');
            document.getElementById('tab-' + tab).className = 'px-4 sm:px-6 py-3 font-medium whitespace-nowrap tab-active';
            renderCurrentTab();
        }

        function showAddButton() {
            if (currentTab === 'orders') openOrderModal();
            else if (currentTab === 'sales') openSaleModal();
            else if (currentTab === 'personal') openPersonalOrderModal();
        }

        function renderCurrentTab() {
            const search = document.getElementById('search').value.toLowerCase();
            document.getElementById('add-btn').classList.toggle('hidden', !['orders', 'sales', 'personal'].includes(currentTab));
            
            if (currentTab === 'dashboard') renderDashboard();
            else if (currentTab === 'orders') renderOrders(search);
            else if (currentTab === 'inventory') renderInventory(search);
            else if (currentTab === 'sales') renderSales(search);
            else if (currentTab === 'clients') renderClients(search);
            else if (currentTab === 'personal') renderPersonalOrders(search);
        }

        function renderDashboard() {
            const totalInvested = orders.reduce((sum, o) => sum + (parseFloat(o.price_somoni) || 0) + (parseFloat(o.final_delivery_price) || 0), 0);
            const totalRevenue = sales.reduce((sum, s) => sum + (parseFloat(s.sale_price) || 0) + (parseFloat(s.delivery_price) || 0), 0);
            const totalProfit = sales.reduce((sum, s) => {
                const item = inventory.find(i => i.id === s.inventory_id);
                const cost = parseFloat(item?.cost_price) || 0;
                const revenue = (parseFloat(s.sale_price) || 0) + (parseFloat(s.delivery_price) || 0);
                return sum + (revenue - cost);
            }, 0);
            const personalSpent = personalOrders.reduce((sum, p) => sum + (parseFloat(p.total_cost) || 0), 0);
            const balance = totalProfit - personalSpent;

            const inTransit = orders.filter(o => o.status === 'in_transit').length;
            const received = orders.filter(o => o.status === 'received').length;

            document.getElementById('content').innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="text-gray-500 text-sm mb-2">üí∞ –ë–∞–ª–∞–Ω—Å</div>
                        <div class="text-3xl font-bold ${balance >= 0 ? 'text-green-600' : 'text-red-600'}">${balance.toFixed(2)} —Å–æ–º</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="text-gray-500 text-sm mb-2">üìà –û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å</div>
                        <div class="text-3xl font-bold text-green-600">${totalProfit.toFixed(2)} —Å–æ–º</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="text-gray-500 text-sm mb-2">üí∏ –í—ã—Ä—É—á–∫–∞</div>
                        <div class="text-3xl font-bold text-blue-600">${totalRevenue.toFixed(2)} —Å–æ–º</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="text-gray-500 text-sm mb-2">üì¶ –ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ</div>
                        <div class="text-3xl font-bold text-orange-600">${totalInvested.toFixed(2)} —Å–æ–º</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="text-gray-500 text-sm mb-2">üè† –ü–æ—Ç—Ä–∞—á–µ–Ω–æ –Ω–∞ —Å–µ–±—è</div>
                        <div class="text-3xl font-bold text-purple-600">${personalSpent.toFixed(2)} —Å–æ–º</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="text-gray-500 text-sm mb-2">üìã –¢–æ–≤–∞—Ä–æ–≤ –≤ –Ω–∞–ª–∏—á–∏–∏</div>
                        <div class="text-3xl font-bold text-indigo-600">${inventory.length}</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-bold text-lg mb-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between"><span>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤:</span><span class="font-bold">${orders.length}</span></div>
                            <div class="flex justify-between"><span>–í –ø—É—Ç–∏:</span><span class="font-bold text-blue-600">${inTransit}</span></div>
                            <div class="flex justify-between"><span>–ü–æ–ª—É—á–µ–Ω–æ:</span><span class="font-bold text-green-600">${received}</span></div>
                            <div class="flex justify-between"><span>–ü—Ä–æ–¥–∞–∂:</span><span class="font-bold text-purple-600">${sales.length}</span></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-bold text-lg mb-4">üë• –¢–æ–ø –∫–ª–∏–µ–Ω—Ç—ã</h3>
                        <div class="space-y-2">
                            ${getTopClients().map(c => `
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span>${c.name}</span>
                                    <span class="font-bold text-green-600">${c.total.toFixed(2)} —Å–æ–º</span>
                                </div>
                            `).join('') || '<div class="text-gray-500 text-center py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö</div>'}
                        </div>
                    </div>
                </div>
            `;
        }

        function getTopClients() {
            const clientsMap = {};
            sales.forEach(s => {
                const total = (parseFloat(s.sale_price) || 0) + (parseFloat(s.delivery_price) || 0);
                const clientName = s.customer_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç';
                if (!clientsMap[clientName]) {
                    clientsMap[clientName] = { name: clientName, total: 0 };
                }
                clientsMap[clientName].total += total;
            });
            return Object.values(clientsMap).sort((a, b) => b.total - a.total).slice(0, 5);
        }

        function renderOrders(search) {
            const filtered = orders.filter(o => 
                (o.order_number || '').toLowerCase().includes(search) ||
                (o.product_name || '').toLowerCase().includes(search) ||
                (o.cargo || '').toLowerCase().includes(search)
            );

            const statusMap = {
                ordered: ['–ó–∞–∫–∞–∑–∞–Ω', 'bg-gray-100 text-gray-800'],
                warehouse_china: ['–ù–∞ —Å–∫–ª–∞–¥–µ', 'bg-yellow-100 text-yellow-800'],
                in_transit: ['–í –ø—É—Ç–∏', 'bg-blue-100 text-blue-800'],
                received: ['–ü–æ–ª—É—á–µ–Ω', 'bg-green-100 text-green-800']
            };

            document.getElementById('content').innerHTML = filtered.length ? `
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full min-w-[640px]">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–¢–æ–≤–∞—Ä</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ö–∞—Ä–≥–æ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–¶–µ–Ω–∞</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–°—Ç–∞—Ç—É—Å</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">${filtered.map(o => {
                            const [name, color] = statusMap[o.status] || ['–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', 'bg-gray-100 text-gray-800'];
                            return `<tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">
                                    ${o.photo_url ? `<img src="${o.photo_url}" class="thumbnail mb-2">` : ''}
                                    <div class="font-medium">${o.product_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                                    <div class="text-sm text-gray-500">#${o.order_number || '–ù–µ—Ç'}</div>
                                </td>
                                <td class="px-4 py-3">${o.cargo || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                                <td class="px-4 py-3">
                                    <div>${o.price_yuan || '0'} ¬•</div>
                                    <div class="text-sm">${o.price_somoni || '0'} —Å–æ–º</div>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 rounded text-xs font-semibold ${color}">${name}</span>
                                </td>
                                <td class="px-4 py-3">
                                    <button onclick='editOrder(${o.id})' class="text-blue-600 mr-2">‚úèÔ∏è</button>
                                    <button onclick='deleteOrder(${o.id})' class="text-red-600">üóëÔ∏è</button>
                                </td>
                            </tr>`;
                        }).join('')}</tbody>
                    </table>
                </div>
            ` : '<div class="bg-white p-12 rounded-lg shadow text-center text-gray-500">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
        }

        function renderInventory(search) {
            const filtered = inventory.filter(i => 
                (i.name || '').toLowerCase().includes(search) ||
                (i.order_number || '').toLowerCase().includes(search)
            );
            
            document.getElementById('content').innerHTML = filtered.length ? `
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full min-w-[640px]">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–¢–æ–≤–∞—Ä</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ö–æ–ª-–≤–æ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–í–µ—Å</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">${filtered.map(i => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">
                                    ${i.photo_url ? `<img src="${i.photo_url}" class="thumbnail mb-2">` : ''}
                                    <div class="font-medium">${i.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                                    <div class="text-sm text-gray-500">#${i.order_number || '–ù–µ—Ç'}</div>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="font-semibold text-green-600">${i.quantity || 1}</span>
                                </td>
                                <td class="px-4 py-3">${i.cost_price || '0'} —Å–æ–º</td>
                                <td class="px-4 py-3">${i.weight || '–ù–µ —É–∫–∞–∑–∞–Ω'} –∫–≥</td>
                            </tr>
                        `).join('')}</tbody>
                    </table>
                </div>
            ` : '<div class="bg-white p-12 rounded-lg shadow text-center text-gray-500">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ –Ω–∞–ª–∏—á–∏–∏</div>';
        }

        function renderSales(search) {
            const filtered = sales.filter(s => 
                (s.customer_name || '').toLowerCase().includes(search) || 
                (s.city || '').toLowerCase().includes(search)
            );
            
            document.getElementById('content').innerHTML = filtered.length ? `
                <div class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="w-full min-w-[640px]">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–î–∞—Ç–∞</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–¢–æ–≤–∞—Ä</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ö–ª–∏–µ–Ω—Ç</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–¶–µ–Ω–∞</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ü—Ä–∏–±—ã–ª—å</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">${filtered.map(s => {
                            const item = inventory.find(i => i.id === s.inventory_id) || {name: '–£–¥–∞–ª–µ–Ω', cost_price: 0};
                            const profit = (parseFloat(s.sale_price) || 0) + (parseFloat(s.delivery_price) || 0) - (parseFloat(item.cost_price) || 0);
                            return `<tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm">${s.sale_date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                                <td class="px-4 py-3">
                                    <div class="font-medium">${item.name}</div>
                                    <div class="text-xs text-gray-500">x${s.quantity || 1}</div>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="font-medium">${s.customer_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}</div>
                                    <div class="text-xs text-gray-500">${s.phone || ''}</div>
                                    <div class="text-xs text-gray-500">${s.city || ''}</div>
                                </td>
                                <td class="px-4 py-3">
                                    ${s.sale_price || '0'} —Å–æ–º
                                    ${s.delivery_type === 'paid' ? `<div class="text-xs text-orange-600">+${s.delivery_price || '0'} –¥–æ—Å—Ç</div>` : ''}
                                </td>
                                <td class="px-4 py-3">
                                    <span class="font-bold ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">${profit.toFixed(2)} —Å–æ–º</span>
                                </td>
                            </tr>`;
                        }).join('')}</tbody>
                    </table>
                </div>
            ` : '<div class="bg-white p-12 rounded-lg shadow text-center text-gray-500">–ù–µ—Ç –ø—Ä–æ–¥–∞–∂</div>';
        }

        function renderClients(search) {
            const clientsMap = {};
            sales.forEach(s => {
                const clientName = s.customer_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç';
                if (!clientsMap[clientName]) {
                    clientsMap[clientName] = {
                        name: clientName,
                        phone: s.phone,
                        city: s.city,
                        total: 0,
                        profit: 0,
                        count: 0,
                        sales: []
                    };
                }
                const item = inventory.find(i => i.id === s.inventory_id) || {cost_price: 0};
                const saleTotal = (parseFloat(s.sale_price) || 0) + (parseFloat(s.delivery_price) || 0);
                const profit = saleTotal - (parseFloat(item.cost_price) || 0);
                
                clientsMap[clientName].total += saleTotal;
                clientsMap[clientName].profit += profit;
                clientsMap[clientName].count += 1;
                clientsMap[clientName].sales.push({...s, profit});
            });

            const clients = Object.values(clientsMap).filter(c => 
                c.name.toLowerCase().includes(search) || 
                (c.city || '').toLowerCase().includes(search)
            ).sort((a, b) => b.total - a.total);

            document.getElementById('content').innerHTML = clients.length ? `
                <div class="space-y-4">
                    ${clients.map(c => `
                        <div class="bg-white p-6 rounded-lg shadow">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                                <div>
                                    <h3 class="text-xl font-bold">${c.name}</h3>
                                    <div class="text-sm text-gray-500">${c.phone || '–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω'} ‚Ä¢ ${c.city || '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-green-600">${c.total.toFixed(2)} —Å–æ–º</div>
                                    <div class="text-sm text-gray-500">–ü—Ä–∏–±—ã–ª—å: ${c.profit.toFixed(2)} —Å–æ–º</div>
                                </div>
                            </div>
                            <div class="border-t pt-4">
                                <div class="font-medium mb-2">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫ (${c.count})</div>
                                <div class="space-y-2">
                                    ${c.sales.map(s => {
                                        const item = inventory.find(i => i.id === s.inventory_id) || {name: '–£–¥–∞–ª–µ–Ω'};
                                        return `
                                            <div class="flex justify-between text-sm bg-gray-50 p-2 rounded">
                                                <span>${s.sale_date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'} - ${item.name}</span>
                                                <span class="font-medium">${s.sale_price || '0'} —Å–æ–º (–ø—Ä–∏–±—ã–ª—å: ${s.profit.toFixed(2)})</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '<div class="bg-white p-12 rounded-lg shadow text-center text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö</div>';
        }

        function renderPersonalOrders(search) {
            const filtered = personalOrders.filter(p => 
                (p.product_name || '').toLowerCase().includes(search) ||
                (p.notes || '').toLowerCase().includes(search)
            );
            const total = filtered.reduce((sum, p) => sum + (parseFloat(p.total_cost) || 0), 0);

            document.getElementById('content').innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <div class="text-sm text-gray-600">–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –Ω–∞ –ª–∏—á–Ω—ã–µ –∑–∞–∫–∞–∑—ã:</div>
                    <div class="text-2xl font-bold text-blue-600">${total.toFixed(2)} —Å–æ–º</div>
                </div>
                ${filtered.length ? `
                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="w-full min-w-[640px]">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–¢–æ–≤–∞—Ä</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–î–∞—Ç–∞</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">${filtered.map(p => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        ${p.photo_url ? `<img src="${p.photo_url}" class="thumbnail mb-2">` : ''}
                                        <div class="font-medium">${p.product_name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                                        ${p.notes ? `<div class="text-sm text-gray-500">${p.notes}</div>` : ''}
                                    </td>
                                    <td class="px-4 py-3 text-sm">${p.order_date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                                    <td class="px-4 py-3">
                                        <div class="font-bold">${p.total_cost || '0'} —Å–æ–º</div>
                                        <div class="text-xs text-gray-500">${p.price_yuan || '0'} ¬•</div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <button onclick='deletePersonalOrder(${p.id})' class="text-red-600">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            `).join('')}</tbody>
                        </table>
                    </div>
                ` : '<div class="bg-white p-12 rounded-lg shadow text-center text-gray-500">–ù–µ—Ç –ª–∏—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>'}
            `;
        }

        // –§–£–ù–ö–¶–ò–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê –° –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ú –î–û–ë–ê–í–õ–ï–ù–ò–ï–ú –í –ù–ê–õ–ò–ß–ò–ï
        function openOrderModal(orderId = null) {
            const order = orderId ? orders.find(o => o.id === orderId) : null;
            
            const data = order || {
                order_number: 'ORDER-' + Date.now(),
                product_name: '',
                price_yuan: '',
                price_somoni: '',
                cargo: '',
                order_date: new Date().toISOString().split('T')[0],
                status: 'ordered',
                has_client: false,
                client_name: '',
                client_phone: '',
                client_city: '',
                client_paid_product: false,
                client_paid_delivery: false,
                estimated_delivery_price: '',
                track_code: '',
                shipping_date: '',
                expected_arrival_date: '',
                final_delivery_price: '',
                weight: '',
                received_date: ''
            };

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">${order ? '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '‚ûï –ù–æ–≤—ã–π'} –∑–∞–∫–∞–∑</h3>
                        <button onclick="this.closest('.modal').remove()" class="text-2xl">&times;</button>
                    </div>
                    <form class="space-y-4">
                        <div>
                            <label class="block text-sm mb-1">üì∏ –§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞</label>
                            <input type="file" accept="image/*" id="order-photo-input" class="w-full border rounded px-3 py-2">
                            ${data.photo_url ? `<img src="${data.photo_url}" class="preview-image mt-2">` : ''}
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm mb-1">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ *</label>
                                <input name="order_number" required class="w-full border rounded px-3 py-2" value="${data.order_number}">
                            </div>
                            <div>
                                <label class="block text-sm mb-1">–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ *</label>
                                <input type="date" name="order_date" required class="w-full border rounded px-3 py-2" value="${data.order_date}">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
                            <input name="product_name" required class="w-full border rounded px-3 py-2" value="${data.product_name}">
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm mb-1">–¶–µ–Ω–∞ (—é–∞–Ω–∏) *</label>
                                <input type="number" step="0.01" name="price_yuan" required class="w-full border rounded px-3 py-2" value="${data.price_yuan}">
                            </div>
                            <div>
                                <label class="block text-sm mb-1">–¶–µ–Ω–∞ (—Å–æ–º–æ–Ω–∏) *</label>
                                <input type="number" step="0.01" name="price_somoni" required class="w-full border rounded px-3 py-2" value="${data.price_somoni}">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm mb-1">–ö–∞—Ä–≥–æ *</label>
                            <input name="cargo" required class="w-full border rounded px-3 py-2" value="${data.cargo}">
                        </div>
                        
                        <!-- –ë–ª–æ–∫ –∫–ª–∏–µ–Ω—Ç–∞ -->
                        <div>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" name="has_client" ${data.has_client ? 'checked' : ''} 
                                       onchange="toggleClientFields(this)">
                                <span class="font-medium text-purple-600">–ï—Å—Ç—å –∫–ª–∏–µ–Ω—Ç (–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞)</span>
                            </label>
                        </div>
                        
                        <div id="clientFields" class="${data.has_client ? '' : 'hidden'} space-y-4 bg-purple-50 p-4 rounded">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm mb-1">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                                    <input name="client_name" class="w-full border rounded px-3 py-2" value="${data.client_name || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                    <input name="client_phone" class="w-full border rounded px-3 py-2" value="${data.client_phone || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm mb-1">–ì–æ—Ä–æ–¥</label>
                                    <input name="client_city" class="w-full border rounded px-3 py-2" value="${data.client_city || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm mb-1">–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                                    <input type="number" step="0.01" name="estimated_delivery_price" 
                                           class="w-full border rounded px-3 py-2" value="${data.estimated_delivery_price || ''}">
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" name="client_paid_product" ${data.client_paid_product ? 'checked' : ''}>
                                    <span class="text-sm">–ö–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—Ç–∏–ª —Ç–æ–≤–∞—Ä</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" name="client_paid_delivery" ${data.client_paid_delivery ? 'checked' : ''}>
                                    <span class="text-sm">–ö–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—Ç–∏–ª –¥–æ—Å—Ç–∞–≤–∫—É</span>
                                </label>
                            </div>
                        </div>

                        <!-- –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ -->
                        <div>
                            <label class="block text-sm mb-1">–°—Ç–∞—Ç—É—Å *</label>
                            <select name="status" required class="w-full border rounded px-3 py-2" 
                                    onchange="toggleStatusFields(this)">
                                <option value="ordered" ${data.status === 'ordered' ? 'selected' : ''}>–ó–∞–∫–∞–∑–∞–Ω</option>
                                <option value="warehouse_china" ${data.status === 'warehouse_china' ? 'selected' : ''}>–ù–∞ —Å–∫–ª–∞–¥–µ –≤ –ö–∏—Ç–∞–µ</option>
                                <option value="in_transit" ${data.status === 'in_transit' ? 'selected' : ''}>–í –ø—É—Ç–∏</option>
                                <option value="received" ${data.status === 'received' ? 'selected' : ''}>–ü–æ–ª—É—á–µ–Ω</option>
                            </select>
                        </div>

                        <!-- –ü–æ–ª—è –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–í –ø—É—Ç–∏" –∏ "–ü–æ–ª—É—á–µ–Ω" -->
                        <div id="transitFields" class="${['in_transit', 'received'].includes(data.status) ? '' : 'hidden'} grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm mb-1">–¢—Ä–µ–∫-–∫–æ–¥</label>
                                <input name="track_code" class="w-full border rounded px-3 py-2" value="${data.track_code || ''}">
                            </div>
                            <div>
                                <label class="block text-sm mb-1">–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</label>
                                <input type="date" name="shipping_date" class="w-full border rounded px-3 py-2" value="${data.shipping_date || ''}">
                            </div>
                            <div>
                                <label class="block text-sm mb-1">–û–∂–∏–¥–∞–µ–º–æ–µ –ø—Ä–∏–±—ã—Ç–∏–µ</label>
                                <input type="date" name="expected_arrival_date" class="w-full border rounded px-3 py-2" value="${data.expected_arrival_date || ''}">
                            </div>
                        </div>

                        <!-- –ü–æ–ª—è –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ü–æ–ª—É—á–µ–Ω" -->
                        <div id="receivedFields" class="${data.status === 'received' ? '' : 'hidden'} bg-green-50 p-4 rounded grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm mb-1">–§–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                                <input type="number" step="0.01" name="final_delivery_price" 
                                       class="w-full border rounded px-3 py-2" value="${data.final_delivery_price || ''}">
                            </div>
                            <div>
                                <label class="block text-sm mb-1">–í–µ—Å (–∫–≥)</label>
                                <input type="number" step="0.01" name="weight" 
                                       class="w-full border rounded px-3 py-2" value="${data.weight || ''}">
                            </div>
                            <div>
                                <label class="block text-sm mb-1">–î–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è</label>
                                <input type="date" name="received_date" 
                                       class="w-full border rounded px-3 py-2" value="${data.received_date || ''}">
                            </div>
                        </div>

                        <div class="flex gap-2 pt-4">
                            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                                ${order ? '–û–±–Ω–æ–≤–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å'} –∑–∞–∫–∞–∑
                            </button>
                            <button type="button" onclick="this.closest('.modal').remove()" class="bg-gray-300 px-6 py-2 rounded">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </form>
                </div>
            `;

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
            modal.querySelector('form').onsubmit = async (e) => {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const newOrder = {
                    order_number: formData.get('order_number'),
                    product_name: formData.get('product_name'),
                    price_yuan: parseFloat(formData.get('price_yuan')) || 0,
                    price_somoni: parseFloat(formData.get('price_somoni')) || 0,
                    cargo: formData.get('cargo'),
                    order_date: formData.get('order_date'),
                    status: formData.get('status'),
                    has_client: formData.get('has_client') === 'on',
                    client_name: formData.get('client_name') || null,
                    client_phone: formData.get('client_phone') || null,
                    client_city: formData.get('client_city') || null,
                    client_paid_product: formData.get('client_paid_product') === 'on',
                    client_paid_delivery: formData.get('client_paid_delivery') === 'on',
                    estimated_delivery_price: parseFloat(formData.get('estimated_delivery_price')) || 0,
                    track_code: formData.get('track_code') || null,
                    shipping_date: formData.get('shipping_date') || null,
                    expected_arrival_date: formData.get('expected_arrival_date') || null,
                    final_delivery_price: parseFloat(formData.get('final_delivery_price')) || 0,
                    weight: parseFloat(formData.get('weight')) || 0,
                    received_date: formData.get('received_date') || null
                };

                try {
                    let result;
                    if (order) {
                        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∑–∞–∫–∞–∑–∞
                        result = await supabase
                            .from('orders')
                            .update(newOrder)
                            .eq('id', order.id)
                            .select();
                    } else {
                        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞
                        result = await supabase
                            .from('orders')
                            .insert([newOrder])
                            .select();
                    }

                    if (result.error) {
                        throw new Error(result.error.message);
                    }

                    if (result.data) {
                        const savedOrder = result.data[0];
                        
                        // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –î–û–ë–ê–í–õ–ï–ù–ò–ï –í –ù–ê–õ–ò–ß–ò–ï –ü–†–ò –°–¢–ê–¢–£–°–ï "–ü–û–õ–£–ß–ï–ù"
                        if (newOrder.status === 'received' && !newOrder.has_client) {
                            await addToInventory(savedOrder);
                        }

                        if (order) {
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∑–∞–∫–∞–∑
                            orders = orders.map(o => o.id === order.id ? {...o, ...newOrder} : o);
                        } else {
                            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑
                            orders.push(savedOrder);
                        }
                        
                        updateCounts();
                        renderCurrentTab();
                        modal.remove();
                        alert('‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                    }
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
                    alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
                }
            };

            document.body.appendChild(modal);
        }

        // –§–£–ù–ö–¶–ò–Ø –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û –î–û–ë–ê–í–õ–ï–ù–ò–Ø –í –ù–ê–õ–ò–ß–ò–ï
        async function addToInventory(order) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –Ω–∞–ª–∏—á–∏–∏
                const existingItem = inventory.find(i => i.order_id === order.id);
                
                if (existingItem) {
                    // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å - –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                    const newQuantity = (existingItem.quantity || 1) + 1;
                    const { error } = await supabase
                        .from('inventory')
                        .update({ quantity: newQuantity })
                        .eq('id', existingItem.id);
                    
                    if (!error) {
                        existingItem.quantity = newQuantity;
                    }
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
                    const newInventoryItem = {
                        order_id: order.id,
                        name: order.product_name,
                        quantity: 1,
                        cost_price: (parseFloat(order.price_somoni) + parseFloat(order.final_delivery_price || 0)).toFixed(2),
                        weight: order.weight,
                        added_date: order.received_date || new Date().toISOString().split('T')[0],
                        order_number: order.order_number,
                        photo_url: order.photo_url
                    };

                    const { data, error } = await supabase
                        .from('inventory')
                        .insert([newInventoryItem])
                        .select();

                    if (!error && data) {
                        inventory.push(data[0]);
                        console.log('‚úÖ –¢–æ–≤–∞—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –Ω–∞–ª–∏—á–∏–µ');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –Ω–∞–ª–∏—á–∏–µ:', error);
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª–µ–π
        function toggleClientFields(checkbox) {
            const clientFields = checkbox.closest('form').querySelector('#clientFields');
            clientFields.classList.toggle('hidden', !checkbox.checked);
        }

        function toggleStatusFields(select) {
            const status = select.value;
            const form = select.closest('form');
            const transitFields = form.querySelector('#transitFields');
            const receivedFields = form.querySelector('#receivedFields');
            
            transitFields.classList.toggle('hidden', !['in_transit', 'received'].includes(status));
            receivedFields.classList.toggle('hidden', status !== 'received');
        }

        function openSaleModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content max-w-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">üí∞ –ù–æ–≤–∞—è –ø—Ä–æ–¥–∞–∂–∞</h3>
                        <button onclick="this.closest('.modal').remove()" class="text-2xl">&times;</button>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <p class="text-yellow-800">–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–¥–∞–∂ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function openPersonalOrderModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content max-w-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">üè† –õ–∏—á–Ω—ã–π –∑–∞–∫–∞–∑</h3>
                        <button onclick="this.closest('.modal').remove()" class="text-2xl">&times;</button>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <p class="text-yellow-800">–§—É–Ω–∫—Ü–∏—è –ª–∏—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function editOrder(id) {
            openOrderModal(id);
        }

        async function deleteOrder(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?')) {
                try {
                    const { error } = await supabase
                        .from('orders')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;

                    orders = orders.filter(o => o.id !== id);
                    updateCounts();
                    renderCurrentTab();
                    alert('‚úÖ –ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω!');
                    
                } catch (error) {
                    alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
                }
            }
        }

        async function deletePersonalOrder(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –ª–∏—á–Ω—ã–π –∑–∞–∫–∞–∑?')) {
                alert('–§—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
            }
        }
    </script>
</body>
</html>